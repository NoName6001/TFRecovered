# TFRecovered

This is an attempt at recreating a Unity Project from [True Facials v0.39](https://mega.nz/file/GPYDRI5B#eXAydXpca5W9K35Xv8_c2N7lcSiOM6IQk9w9fU941_o)

## What has been done:

By using [UtinyRipper](https://github.com/mafaca/UtinyRipper) on the build, we can recreate a mostly complete unity project.  
(it generated a Unity 2017 project that has been re-upgraded to the original build version of Unity 2019.3.5f)

However, 2 important things are wrong with the resulting project:
* C# code contains only inspector fields but no logic
* Shaders are incompatible, they trigger a syntax error from Unity

To recover the C# code, [DnSpy](https://github.com/dnSpy/dnSpy) seems to be the best option since the original project used Unity Mono Bleeding Edge

Running DnSpy's Debugger with the game has not been done successfully.  
To do so, you need to recompile a [DnSpy patched version of mono-2.0-bdwgc.dll](https://github.com/dnSpy/dnSpy-Unity-mono) for the correct version of Unity 2019.3.5f, which I gave up on trying.

Running DnSpy on the game's `Assembly-CSharp.dll` (located in `TrueFacials_Data/Managed/`) lets us see decompiled code and export the classes files.

Another issue we can see here is the Obfuscated names of most variable, methods and classes.  
This the product of a unity package named BeeByte, an obfuscator that changes names to random letters.

There are also multiple uses of accessor methods using `k__backingField` which are generated by the compiler when using auto properties like `myVariable {get; set;}`  
We need to change those back to the variable they represent to get the scripts to work again in the Unity project.

And there are also multiples uses of `<>c.<>9` which is again generated by the compiler, this time when using Anonymous functions `() => {}`  

Because obfuscation is making thing very difficult, work on version 0.39 has been suspended for now.

### Using a previous version without obfuscation

The last non-obfuscated version is v0.34C, [old patreon posts available here for free](https://yiff.party/patreon/23228933)  
Using the same process, we can maybe manage to get a clean base to then upgrade from v0.34C to v0.39 by comparing the decompiled code with its v0.34 counterpart.

In order to have to work with as little DnSpy code as possible, we need to import back the originals unity packages, with valid and readable code.  
Prefabs, scenes and scriptable objects reference the scripts they need by their GUID, which is stored in the `.meta` file.  
Reimporting the original packages (with the correct package version) should be relatively painless, and by using [Unity-GUID-Remapper](https://github.com/wafflehammer/Unity-GUID-Remapper---hxrmn) we can fix the references to the reimported scripts.  
We don't know which version of the packages were used, so finding compatible packages is a bit of trial and error, and may require to make some changes in the code. (Some alteration of the packages source code seems to have been made by the original creator anyway)  

The issue with shaders is that they are not decompiled by the recovery process of UtinyRipper.  
A promissing tool called [DXDecompiler](https://github.com/spacehamster/DXDecompiler) is in the works, but isn't done yet.

## Packages used by the game

The game uses a number of unity packages, some of which aren't free.  
The one that have been found so far:
- [Curvy Splines](https://assetstore.unity.com/packages/tools/utilities/curvy-splines-7038) (with modifications to the source code)
- [Final IK](https://assetstore.unity.com/packages/tools/animation/final-ik-14290)
- [FXAA](https://assetstore.unity.com/packages/vfx/shaders/fullscreen-camera-effects/fxaa-fast-approximate-anti-aliasing-3590#content) (free)
- [Human Shader Pack](https://assetstore.unity.com/packages/vfx/shaders/human-shader-pack-135145) (maybe, shader names are oddly similar)
- [Magica Cloth](https://assetstore.unity.com/packages/tools/physics/magica-cloth-160144) (seen in DnSpy, but doesn't seem to be used in code)
- [MoonSharp](https://assetstore.unity.com/packages/tools/moonsharp-33776) (free) (seen in DnSpy, but doesn't to be used in code)
- [Obi Fluid](https://assetstore.unity.com/packages/tools/physics/obi-fluid-63067)
- [Oculus lip sync](https://developer.oculus.com/downloads/package/oculus-lipsync-unity/) (free)
- [Puppet Master](https://assetstore.unity.com/packages/tools/physics/puppetmaster-48977) (with modifications to the source code)
- [Sox Animation Toolkit](https://assetstore.unity.com/packages/tools/animation/sox-animation-toolkit-110431) (free)